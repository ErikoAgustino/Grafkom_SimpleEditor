<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <script src="script/DrawCommand.js"></script>
    <title>Test</title>

    <style>
        * {
            box-sizing: border-box;
            -webkit-user-select: none;
            -webkit-touch-callout: none;
            -moz-user-select: none;
            -ms-user-select: none;
            user-select: none;
        }

        .column {
            float: left;
            padding: 16px;
        }

        .left,
        .right {
            width: 24%;
        }


        .middle {
            width: 52%;
        }

        .row:after {
            content: "";
            display: table;
            clear: both;
        }

        .ghost {
            position: absolute;
            transition: 0s;
            transform: translate(10%, -70%);
            display: none;
        }

        .mainCanvas {
            border: 2px solid black;
            margin: auto;
            position: absolute;
            top: 0;
            bottom: 0;
            left: 0;
            right: 0;
        }
    </style>
</head>

<body>
    <div id="cursor" class="ghost">
    </div>

    <div class="row">
        <div class="column left">
            <ul>
                <li><input type="button" id="circle" onclick="Select(this)" value="Circle"></li>
                <li><input type="button" id="polyline" onclick="Select(this)" value="Polyline"></li>
                <li><input type="button" id="polygon" onclick="Select(this)" value="Polygon"></li>
                <li><input type="button" id="fill" onclick="Select(this)" value="Fill"></li>
                <li><input type="button" id="pen" onclick="Select(this)" value="Pen"></li>
                <li><input type="button" id="cryon" onclick="Select(this)" value="Cryon"></li>
                <li><input type="button" id="erase" onclick="Select(this)" value="Erase"></li>
                <li><input type="button" id="export" onclick="DownloadAsPng()" value="Export Png"></li>
            </ul>
        </div>

        <div class="column middle">
            <canvas id="mainCanvas" class="mainCanvas" width="750" height="750"></canvas>
        </div>

        <div class="column right">
            <div id="global">
                <label for="color">Color</label><br>
                <input type="color" value="#000000" id="color">
            </div>

            <div style="display: none;" id="circleGroup">
                <label for="radius">Radius</label><br>
                <input type="number" min="5" max="500" value="20" id="radius">
            </div>

            <div style="display: none;" id="polylineGroup">
                <label for="polylineDot">Number of Dot</label><br>
                <input type="number" min="3" max="500" value="3" id="polylineDot">
            </div>

            <div style="display: none;" id="polygonGroup">
                <label for="polygonRadius">Radius</label><br>
                <input type="number" min="2" max="500" value="20" id="polygonRadius">
                <br>
                <label for="polygonVertices">Vertices</label><br>
                <input type="number" min="3" max="500" value="3" id="polygonVertices">
            </div>

            <div style="display: none;" id="penGroup">
                <label for="sizePen">Size</label><br>
                <input type="number" min="1" max="10" value="5" id="sizePen">
            </div>

            <div style="display: none;" id="cryonGroup">
                <label for="sizeCryon">Size</label><br>
                <input type="number" min="1" max="10" value="5" id="sizeCryon">
            </div>

            <div style="display: none;" id="eraseGroup">
                <label for="sizeErase">Size</label><br>
                <input type="number" min="1" max="10" value="5" id="sizeErase">
            </div>
        </div>
    </div>

    <script>

        mainCanvas = document.querySelector("#mainCanvas");

        var ctx;
        ctx = mainCanvas.getContext("2d");
        ctx.fillStyle = "#FFFFFF";
        ctx.fillRect(0, 0, mainCanvas.width, mainCanvas.height);
        var imageData = ctx.getImageData(0, 0, mainCanvas.width, mainCanvas.height);

        var selected = null;
        var polylineCoordinate = [];
        var cursor = document.querySelector("#cursor");

        var isMouseDown = false;

        mainCanvas.addEventListener('mousedown', (e) => {
            isMouseDown = true;
        });

        mainCanvas.addEventListener('mouseup', (e) => {
            isMouseDown = false;
        });

        //Draw and Erase
        mainCanvas.addEventListener('mousemove', (e) => {
            if (selected != null) {
                cursor.style.left = e.clientX + "px";
                cursor.style.top = e.clientY + "px";
            }
            if (selected == "erase" && isMouseDown) {
                var size = document.querySelector("#sizeErase").value;
                var coordinate = { x: e.clientX - mainCanvas.offsetLeft, y: e.clientY - mainCanvas.offsetTop };

                drawFullCircle(imageData, coordinate, size, { r: 255, g: 255, b: 255, a: 255 }, mainCanvas);
                ctx.putImageData(imageData, 0, 0);
            } else if (selected == "cryon" && isMouseDown) {
                var size = document.querySelector("#sizeCryon").value;
                var color = HextoRGB(document.querySelector("#color").value);
                var coordinate = { x: e.clientX - mainCanvas.offsetLeft, y: e.clientY - mainCanvas.offsetTop };

                drawSimpleFullCircle(imageData, coordinate, size, color, mainCanvas);
                ctx.putImageData(imageData, 0, 0);
            } else if (selected == "pen" && isMouseDown) {
                var size = document.querySelector("#sizeCryon").value;
                var color = HextoRGB(document.querySelector("#color").value);
                var coordinate = { x: e.clientX - mainCanvas.offsetLeft, y: e.clientY - mainCanvas.offsetTop };

                drawFullCircle(imageData, coordinate, size, color, mainCanvas);
                ctx.putImageData(imageData, 0, 0);
            }
        });

        //Object 2d
        mainCanvas.addEventListener('click', (e) => {
            var color = HextoRGB(document.querySelector("#color").value);
            var coordinate = { x: e.clientX - mainCanvas.offsetLeft, y: e.clientY - mainCanvas.offsetTop };
            switch (selected) {
                case "circle":
                    var radius = document.querySelector("#radius").value;
                    if (radius > 0) {
                        drawCircle(imageData, coordinate, radius, color, mainCanvas);
                        ctx.putImageData(imageData, 0, 0);
                    }
                    break;
                case "polyline":
                    var num = document.querySelector("#polylineDot").value;
                    if (num > 0) {
                        polylineCoordinate.push(coordinate);
                        drawDot(imageData, coordinate, color, mainCanvas);
                        document.querySelector("#polylineDot").value -= 1;
                        if (num == 1) {
                            if (polylineCoordinate.length > 1) {
                                drawPolyline(imageData, polylineCoordinate, color, mainCanvas);
                            }
                            polylineCoordinate = [];
                        }
                        ctx.putImageData(imageData, 0, 0);
                    }

                    break;
                case "polygon":
                    var radiusPolygon = document.querySelector("#polygonRadius").value;
                    var vertices = document.querySelector("#polygonVertices").value;
                    if (radiusPolygon > 0 && vertices > 0) {
                        drawPolygonFixed(imageData, coordinate, radiusPolygon, vertices, color, mainCanvas);
                        ctx.putImageData(imageData, 0, 0);
                    }
                    break;
                case "fill":
                    floodFillStack2(imageData, coordinate, color, mainCanvas);
                    ctx.putImageData(imageData, 0, 0);
                    break;
            }
        });


        function Select(data) {
            reset();
            document.querySelector("#" + data.id).disabled = true;
            try {
                document.querySelector("#" + data.id + "Group").style.display = "block";
            } catch (e) {
                console.log("no attribute")
            }
            // cursor.style.display = "block";
            // var text = document.createTextNode(data.id);
            // cursor.appendChild(text);
            selected = data.id;
        }

        function HextoRGB(hex) {
            var r = parseInt(hex.substr(1, 2), 16);
            var g = parseInt(hex.substr(3, 2), 16);
            var b = parseInt(hex.substr(5, 2), 16);
            return { r: r, g: g, b: b, a: 255 };
        }

        //https://gist.github.com/Kaundur/2aca9a9edb003555f44195e826af4084
        function DownloadAsPng() {
            var image = mainCanvas.toDataURL();
            var downloadLink = document.createElement("a");
            downloadLink.download = "image.png";
            downloadLink.href = image;
            downloadLink.click();
        }

        function reset() {
            selected = null;
            polylineCoordinate = [];

            document.querySelector("#circle").disabled = false;
            document.querySelector("#circleGroup").style.display = "none";
            document.querySelector("#cryon").disabled = false;
            document.querySelector("#cryonGroup").style.display = "none";
            document.querySelector("#pen").disabled = false;
            document.querySelector("#penGroup").style.display = "none";
            document.querySelector("#erase").disabled = false;
            document.querySelector("#eraseGroup").style.display = "none";
            document.querySelector("#polyline").disabled = false;
            document.querySelector("#polylineGroup").style.display = "none";
            document.querySelector("#polygon").disabled = false;
            document.querySelector("#polygonGroup").style.display = "none";
            document.querySelector("#fill").disabled = false;

        }

        ctx.putImageData(imageData, 0, 0);

    </script>
</body>

</html>